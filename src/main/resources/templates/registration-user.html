<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link rel="stylesheet" th:href="@{/css/login.css}" type="text/css">
    <script src="https://unpkg.com/htmx.org@1.9.5"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
    <link rel = "stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body>
<div class="login-container">
    <div class="login-box">
        <div class="login-title">IRTSU CAS</div>
        <form class="login-form"
              th:object="${registerForm}"
              hx-post="/auth/register"
              hx-trigger="submit"
              hx-target="body"
              hx-swap="none"
              hx-headers='{"Content-Type": "application/json"}'
              hx-ext="json-enc">
            <div class="form-group">
                <label for="email">Email</label>
                <input
                        id="email"
                        name="email"
                        type="email"
                        class="form-input"
                        placeholder="Введите email"
                        required
                        th:field="*{email}"
                />
            </div>
            <div class="form-group">
                <label for="name">Имя</label>
                <input
                        id="name"
                        name="name"
                        type="text"
                        class="form-input"
                        placeholder="Введите пароль"
                        required
                        th:field="*{name}"
                />
            </div>

            <div class="form-group">
                <label for="lastName">Фамилия</label>
                <input
                        id="lastName"
                        name="lastName"
                        type="text"
                        class="form-input"
                        placeholder="Введите пароль"
                        required
                        th:field="*{lastName}"
                />
            </div>

            <div class="form-group">
                <label for="surname">Отчество</label>
                <input
                        id="surname"
                        name="surname"
                        type="text"
                        class="form-input"
                        placeholder="Введите пароль"
                        required
                        th:field="*{surname}"
                />
            </div>

            <div class="form-group">
                <label for="phone">Номер Телефона</label>
                <input
                        id="phone"
                        name="phone"
                        type="text"
                        class="form-input"
                        placeholder="Введите пароль"
                        required
                        th:field="*{phone}"
                />
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input
                        id="password"
                        name="password"
                        type="password"
                        class="form-input"
                        placeholder="Введите пароль"
                        required
                        th:field="*{password}"
                />
            </div>
            <button type="submit" class="login-button">Регистрация</button>
            <a class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="/authUser/login">Login</a>
        </form>


    </div>
</div>

<!-- Секция для обработки ответа сервера (токен) -->
<div id="response"></div>
<script>
    document.querySelector(".login-form").addEventListener("submit", function(event) {
        event.preventDefault(); // Остановить отправку формы, если есть ошибки

        let email = document.getElementById("email").value.trim();
        let name = document.getElementById("name").value.trim();
        let lastName = document.getElementById("lastName").value.trim();
        let surname = document.getElementById("surname").value.trim();
        let phone = document.getElementById("phone").value.trim();
        let password = document.getElementById("password").value;

        let errors = [];

        // Проверка Email
        let emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            errors.push("Введите корректный email.");
        }

        // Проверка имени и фамилии (только буквы)
        let nameRegex = /^[А-Яа-яЁёA-Za-z]+$/;
        if (!nameRegex.test(name)) {
            errors.push("Имя должно содержать только буквы.");
        }
        if (!nameRegex.test(lastName)) {
            errors.push("Фамилия должна содержать только буквы.");
        }

        // Проверка номера телефона (пример: +7(999)999-99-99)
        let phoneRegex = /^\+?\d{1,3}?[-.\s]?\(?\d{1,4}?\)?[-.\s]?\d{1,4}[-.\s]?\d{1,9}$/;
        if (!phoneRegex.test(phone)) {
            errors.push("Введите корректный номер телефона.");
        }

        // Проверка пароля (минимум 6 символов)
        if (password.length < 6) {
            errors.push("Пароль должен содержать минимум 6 символов.");
        }

        // Вывод ошибок
        if (errors.length > 0) {
            alert(errors.join("\n"));
            return;
        }

        event.target.submit(); // Если ошибок нет — отправляем форму
    });
</script>

<script>
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.xhr.status === 200) {
            try {
                let response = JSON.parse(event.detail.xhr.responseText);
                if (response.data.token) {
                    let token = response.data.token.replace("Bearer ", "")
                    console.log("save token")
                    // Сохраняем токен в localStorage
                    localStorage.setItem('token', token);
                    document.getElementById("response").innerHTML = "<div style='color: green;'>Авторизация успешна</div>";
                    console.log("Токен сохранен:", token);
                    window.location.href = "/authUser/profile";
                } else {
                    document.getElementById("response").innerHTML = "<div style='color: red;'>Ошибка авторизации</div>";
                }
            } catch (e) {
                document.getElementById("response").innerHTML = "<div style='color: red;'>Ошибка обработки ответа</div>";
            }
        } else {
            document.getElementById("response").innerHTML = "<div style='color: red;'>Ошибка сервера</div>";
        }
    });
</script>


</body>
</html>
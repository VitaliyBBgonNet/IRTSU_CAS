<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <link rel="stylesheet" th:href="@{/css/table.css}" type="text/css">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <title>Profile</title>
  <style>
    .documentation-link {
      display: inline-block;
      max-width: 100px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-decoration: none;
      color: #007bff;
      cursor: pointer;
    }
    .documentation-link:hover {
      text-decoration: underline;
      color: #0056b3;
    }
    #invalidDocumentationModal .modal-body {
      word-wrap: break-word;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
<div class="container py-3">
  <div th:replace="~{header.html :: header}"></div>
</div>

<div class="container py-3">
  <div class="text-center">
    <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
      <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"></path>
      <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"></path>
    </svg>
  </div>
  <div class="text-center">
    <p id="full-name" hx-get="/data/profile" hx-trigger="load" hx-target="#full-name" hx-swap="innerHTML" class="">Vitaliy_ Goncharov Victorovich</p>
  </div>
  <div class="col-12">
    <form id="filterForm">
      <p class="fw-bold">Фильтр:</p>
      <div class="d-flex flex-wrap align-items-center gap-2">
        <input type="text" id="componentNameFilter" class="form-control w-auto" placeholder="Имя компонента">
        <button type="submit" class="btn btn-primary">Выбрать</button>
        <button id="loadTableBtn" class="btn btn-primary">Все комплектующие</button>
      </div>
    </form>
  </div>
  <br>
  <div class="col">
    <table class="table table-sm table-hover">
      <thead>
      <tr>
        <th>ID</th>
        <th>Имя компонента</th>
        <th>Описание</th>
        <th>Документация</th>
        <th>Действие</th>
      </tr>
      </thead>
      <tbody id="componentListBody"></tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="invalidDocumentationModal" tabindex="-1" aria-labelledby="invalidDocumentationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="invalidDocumentationModalLabel">Невалидная ссылка на документацию</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="invalidDocumentationText"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Загрузка таблицы при открытии страницы
    loadTable({});

    const invalidModal = document.getElementById("invalidDocumentationModal");
    invalidModal.addEventListener("hidden.bs.modal", function () {
      document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
      document.body.classList.remove("modal-open");
      document.body.style.paddingRight = "";
    });
  });

  document.body.addEventListener("htmx:responseError", function (event) {
    if (event.detail.xhr.status === 401) {
      console.warn("Неавторизованный доступ, перенаправление на страницу логина");
      window.location.href = "/authUser/login";
    }
  });

  document.addEventListener("htmx:configRequest", function(event) {
    let token = localStorage.getItem("token");
    if (token) {
      event.detail.headers['Authorization'] = 'Bearer ' + token;
    } else {
      console.warn("Токен отсутствует для HTMX запроса");
    }
  });

  function isValidUrl(url) {
    if (!url || url.trim() === '') return false;
    try {
      new URL(url);
      return true;
    } catch (e) {
      return false;
    }
  }

  document.getElementById("filterForm").addEventListener("submit", function(event) {
    event.preventDefault();
    const filterData = {
      name: document.getElementById("componentNameFilter").value.trim()
    };
    loadTable(filterData);
  });

  document.getElementById("loadTableBtn").addEventListener("click", function() {
    loadTable({});
  });

  function loadTable(filterData) {
    const token = localStorage.getItem("token");
    fetch("/details/getDetailWitchPaginationFilterForAuthUser", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": token ? "Bearer " + token : ""
      },
      body: JSON.stringify(filterData)
    })
            .then(response => {
              if (!response.ok) {
                throw new Error("Ошибка загрузки данных: " + response.status);
              }
              return response.json();
            })
            .then(data => {
              let tableBody = document.getElementById("componentListBody");
              tableBody.innerHTML = "";
              data.forEach(component => {
                let row = document.createElement("tr");
                row.innerHTML = `
                        <td><p class="shortened-id">${component.id}</p></td>
                        <td>${component.name}</td>
                        <td>${component.description}</td>
                        <td><span class="documentation-link" data-documentation="${component.documentation || ''}">Документация</span></td>
                        <td>
                            <button style="margin: 2px" class="btn btn-success" data-id="${component.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
                                    <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z"/>
                                </svg>
                            </button>
                        </td>
                    `;
                tableBody.appendChild(row);
              });
            })
            .catch(error => console.error("Ошибка загрузки данных:", error));
  }

  document.getElementById("componentListBody").addEventListener("click", function(event) {
    const rentButton = event.target.closest(".btn-success");
    if (rentButton) {
      const itemId = rentButton.getAttribute("data-id");
      if (!confirm(`Точно ли хотите взять в аренду компонент с ID ${itemId}?`)) {
        return;
      }
      fetch(`/details/update`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + localStorage.getItem("token")
        },
        body: JSON.stringify({
          id: itemId,
          status: "В аренде",
          tenant: "current_user_id" // Замените на реальный ID текущего пользователя
        })
      })
              .then(response => {
                if (!response.ok) throw new Error("Ошибка при взятии в аренду!");
                return response.json();
              })
              .then(data => {
                alert("Компонент успешно взят в аренду!");
                document.getElementById("loadTableBtn").click();
              })
              .catch(error => console.error("Ошибка при аренде:", error));
    }

    const documentationLink = event.target.closest('.documentation-link');
    if (documentationLink) {
      const documentationUrl = documentationLink.getAttribute('data-documentation');
      if (isValidUrl(documentationUrl)) {
        window.open(documentationUrl, '_blank');
      } else {
        document.getElementById('invalidDocumentationText').textContent = documentationUrl || 'Ссылка не указана';
        const modal = new bootstrap.Modal(document.getElementById('invalidDocumentationModal'));
        modal.show();
      }
    }
  });
</script>

<script src="https://unpkg.com/htmx.org@1.8.4"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>